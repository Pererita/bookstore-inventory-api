name: CI - Bookstore Inventory API

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  ci:
    runs-on: ubuntu-latest
    
    env:
      SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
      DB_USER: ${{ secrets.POSTGRES_USER }}
      DB_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      
      DB_NAME: bookstore_db
      DB_HOST: db
      DB_PORT: 5432
      DEBUG: 1
      EXCHANGE_RATE_API_URL: https://api.exchangerate-api.com/v4/latest/USD
      LOCAL_CURRENCY: VES
      PROFIT_MARGIN: 0.40

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      # 1. Crea un archivo de override temporal y levanta los contenedores
      - name: Build y Start Docker Compose (con Override de Comando)
        run: |
          # Crea el archivo override que mantiene vivo el contenedor 'web'
          echo 'services:
            web:
              command: /bin/sh -c "while true; do sleep 30; done"' > docker-compose.ci.yml
          
          # Levanta los servicios usando el archivo principal y el override
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up --build -d

      # 2. Espera a que PostgreSQL esté lista usando un script de shell
      - name: Esperar a que PostgreSQL esté lista
        run: |
          echo "Esperando a que la base de datos esté lista..."
          max_retries=10
          delay=6
          for i in $(seq 1 $max_retries); do
            # Intenta conectarse a la BD dentro del contenedor 'db'
            if docker compose exec db pg_isready -h localhost -p 5432 -U $DB_USER 2>/dev/null; then
              echo "PostgreSQL está lista."
              exit 0
            fi
            echo "Intento $i de $max_retries. Esperando $delay segundos..."
            sleep $delay
          done
          echo "Error: PostgreSQL no está lista después de múltiples reintentos."
          exit 1
          
      # 3. Aplicar Migraciones
      - name: Aplicar Migraciones
        run: docker compose exec -T web python manage.py migrate
        
      # 4. Ejecuta las pruebas unitarias
      - name: Ejecutar Pruebas de Django
        run: docker compose exec -T web python manage.py test inventory
      
      # 5. Limpieza
      - name: Detener y Eliminar Contenedores
        if: always() 
        run: docker compose down -v